name: CD - Build & Deploy to AWS

on:
  # CD runs on push to main (after PR merge from dev)
  push:
    branches: [main]
    tags:
      - "v*"
  # CD also runs on PRs targeting main (for validation, no deploy)
  pull_request:
    branches: [main]

  # Manual deployment with specific image tag (for rollback)
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (e.g., sha-abc1234 or v1.0.0). Leave empty to build fresh."
        required: false
        type: string
      skip_health_check:
        description: "Skip health check after deployment"
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===========================================================================
  # Build and Push API Docker Image
  # ===========================================================================
  build-api:
    name: Build & Push API Image
    runs-on: ubuntu-latest
    # Skip build if manual dispatch with existing image tag
    if: ${{ github.event.inputs.image_tag == '' || github.event.inputs.image_tag == null }}
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
      short-sha: ${{ steps.vars.outputs.short-sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set variables
        id: vars
        run: echo "short-sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for API image
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch,suffix=-api
            type=ref,event=pr,suffix=-api
            type=semver,pattern={{version}},suffix=-api
            type=semver,pattern={{major}}.{{minor}},suffix=-api
            type=sha,prefix=sha-,suffix=-api
            type=raw,value=api,enable={{is_default_branch}}

      - name: Build and push API image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        if: github.event_name != 'pull_request'
        continue-on-error: true
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ github.sha }}-api
          artifact-name: sbom-api.spdx.json

  # ===========================================================================
  # Build and Push UI Docker Image
  # ===========================================================================
  build-ui:
    name: Build & Push UI Image
    runs-on: ubuntu-latest
    # Skip build if manual dispatch with existing image tag
    if: ${{ github.event.inputs.image_tag == '' || github.event.inputs.image_tag == null }}
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
      short-sha: ${{ steps.vars.outputs.short-sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set variables
        id: vars
        run: echo "short-sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for UI image
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch,suffix=-ui
            type=ref,event=pr,suffix=-ui
            type=semver,pattern={{version}},suffix=-ui
            type=semver,pattern={{major}}.{{minor}},suffix=-ui
            type=sha,prefix=sha-,suffix=-ui
            type=raw,value=ui,enable={{is_default_branch}}

      - name: Build and push UI image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./ui
          file: ./ui/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
          build-args: |
            API_BASE_URL=http://api:8000
            NEXT_PUBLIC_API_URL=http://localhost:8000

  # ===========================================================================
  # Deploy to AWS EC2 via Docker Compose
  # ===========================================================================
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: [build-api, build-ui]
    # Only deploy on push to main or manual dispatch (not PRs)
    if: |
      always() &&
      github.event_name != 'pull_request' &&
      (needs.build-api.result == 'success' || needs.build-api.result == 'skipped') &&
      (needs.build-ui.result == 'success' || needs.build-ui.result == 'skipped')
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine image tag
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            # Manual deployment with provided tag
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
            echo "ðŸ”– Using manual tag: ${{ github.event.inputs.image_tag }}"
          else
            # Use SHA from current commit
            SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
            echo "tag=sha-${SHORT_SHA}" >> $GITHUB_OUTPUT
            echo "ðŸ”– Using SHA tag: sha-${SHORT_SHA}"
          fi

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify images exist in registry
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          echo "ðŸ” Verifying images exist..."
          
          # Check API image
          docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}-api > /dev/null 2>&1 || {
            echo "âŒ API image not found: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}-api"
            exit 1
          }
          echo "âœ… API image found"
          
          # Check UI image
          docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}-ui > /dev/null 2>&1 || {
            echo "âŒ UI image not found: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}-ui"
            exit 1
          }
          echo "âœ… UI image found"

      - name: Verify Docker on EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER || 'ubuntu' }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -e
            
            echo "ðŸ” Verifying Docker installation..."
            
            # Check if Docker is installed
            if ! command -v docker &> /dev/null; then
              echo "âŒ Docker is not installed on this server!"
              echo ""
              echo "To install Docker, run:"
              echo "  curl -fsSL https://get.docker.com -o get-docker.sh"
              echo "  sudo sh get-docker.sh"
              echo "  sudo usermod -aG docker \$USER"
              exit 1
            fi
            
            # Check Docker version
            DOCKER_VERSION=$(docker --version)
            echo "âœ… Docker installed: $DOCKER_VERSION"
            
            # Check if Docker Compose is available (v2 plugin or standalone)
            if docker compose version &> /dev/null; then
              COMPOSE_VERSION=$(docker compose version --short)
              echo "âœ… Docker Compose (plugin) installed: $COMPOSE_VERSION"
            elif command -v docker-compose &> /dev/null; then
              COMPOSE_VERSION=$(docker-compose --version)
              echo "âœ… Docker Compose (standalone) installed: $COMPOSE_VERSION"
            else
              echo "âŒ Docker Compose is not installed!"
              echo ""
              echo "Docker Compose V2 is recommended. To install:"
              echo "  sudo apt-get update"
              echo "  sudo apt-get install docker-compose-plugin"
              exit 1
            fi
            
            # Check if Docker daemon is running
            if ! docker info &> /dev/null; then
              echo "âŒ Docker daemon is not running!"
              echo ""
              echo "To start Docker:"
              echo "  sudo systemctl start docker"
              exit 1
            fi
            echo "âœ… Docker daemon is running"
            
            # Check if user has Docker permissions
            if ! docker ps &> /dev/null; then
              echo "âŒ Current user doesn't have Docker permissions!"
              echo ""
              echo "To fix:"
              echo "  sudo usermod -aG docker \$USER"
              echo "  # Then log out and log back in"
              exit 1
            fi
            echo "âœ… User has Docker permissions"
            
            echo ""
            echo "ðŸŽ‰ All Docker prerequisites verified!"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.2.0
        env:
          IMAGE_TAG: ${{ steps.tag.outputs.tag }}
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER || 'ubuntu' }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          envs: IMAGE_TAG
          script: |
            set -e
            
            echo "ðŸš€ Starting deployment with tag: ${IMAGE_TAG}"
            
            # Login to GHCR
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Create deployment compose file
            cat > docker-compose.deploy.yml <<EOF
            version: "3.9"
            services:
              api:
                image: ghcr.io/${{ github.repository }}:${IMAGE_TAG}-api
                env_file:
                  - /home/ubuntu/.env.credit-score
                ports:
                  - "8000:8000"
                restart: unless-stopped
                healthcheck:
                  test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s

              ui:
                image: ghcr.io/${{ github.repository }}:${IMAGE_TAG}-ui
                environment:
                  API_BASE_URL: http://api:8000
                  NEXT_PUBLIC_API_URL: http://api:8000
                  GOOGLE_GENERATIVE_AI_API_KEY: \${GOOGLE_GENERATIVE_AI_API_KEY}
                  SESSION_SECRET: \${SESSION_SECRET}
                depends_on:
                  - api
                ports:
                  - "3000:3000"
                restart: unless-stopped

            networks:
              default:
                name: credit-score-network
            EOF
            
            # Pull latest images
            echo "ðŸ“¦ Pulling images..."
            docker compose -f docker-compose.deploy.yml pull
            
            # Deploy with zero-downtime (stop old, start new)
            echo "ðŸ”„ Deploying new containers..."
            docker compose -f docker-compose.deploy.yml up -d --remove-orphans
            
            # Clean up old images
            docker image prune -f
            
            echo "âœ… Deployment completed!"
            echo "ðŸ“ Deployed tag: ${IMAGE_TAG}"

      - name: Health check
        if: ${{ github.event.inputs.skip_health_check != 'true' }}
        run: |
          echo "â³ Waiting for services to start..."
          sleep 30
          
          echo "ðŸ” Running health checks..."
          
          # Check API health
          API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.DEPLOY_HOST }}:8000/health || echo "000")
          if [ "$API_STATUS" == "200" ]; then
            echo "âœ… API is healthy (HTTP $API_STATUS)"
          else
            echo "âš ï¸ API health check returned HTTP $API_STATUS"
          fi
          
          # Check UI health
          UI_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.DEPLOY_HOST }}:3000 || echo "000")
          if [ "$UI_STATUS" == "200" ]; then
            echo "âœ… UI is healthy (HTTP $UI_STATUS)"
          else
            echo "âš ï¸ UI health check returned HTTP $UI_STATUS"
          fi

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Tag** | \`${{ steps.tag.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **API Image** | \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}-api\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **UI Image** | \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}-ui\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deployed At** | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Access" >> $GITHUB_STEP_SUMMARY
          echo "- API: http://${{ secrets.DEPLOY_HOST }}:8000" >> $GITHUB_STEP_SUMMARY
          echo "- UI: http://${{ secrets.DEPLOY_HOST }}:3000" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Create Release (on tag push)
  # ===========================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-api, build-ui]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get tag name
        id: tag
        run: |
          TAG_NAME="${{ github.ref_name }}"
          echo "name=${TAG_NAME}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        uses: orhun/git-cliff-action@v3
        with:
          config: .github/cliff.toml
          args: --latest --strip header
        continue-on-error: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.name }}
          body: |
            ## Docker Images

            **API Image:**
            ```
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.name }}-api
            ```

            **UI Image:**
            ```
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.name }}-ui
            ```

            ## Changelog
            ${{ steps.changelog.outputs.content }}
          draft: false
          prerelease: ${{ contains(steps.tag.outputs.name, 'alpha') || contains(steps.tag.outputs.name, 'beta') || contains(steps.tag.outputs.name, 'rc') }}

  # ===========================================================================
  # Build Status Summary
  # ===========================================================================
  notify:
    name: Build Status Summary
    runs-on: ubuntu-latest
    needs: [build-api, build-ui, deploy]
    if: always()
    steps:
      - name: Check build and deploy status
        run: |
          echo "## ðŸ“Š Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build API | ${{ needs.build-api.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build UI | ${{ needs.build-ui.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build-api.result }}" == "success" ] && [ "${{ needs.build-ui.result }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All builds succeeded!" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-api.result }}" == "skipped" ] && [ "${{ needs.build-ui.result }}" == "skipped" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â­ï¸ Builds skipped (using existing image)" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ Some jobs failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
