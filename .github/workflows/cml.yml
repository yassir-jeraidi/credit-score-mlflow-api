name: CML - Continuous Machine Learning

on:
  push:
    branches: [main, dev]
    paths:
      - "ml/**"
      - "requirements.txt"
      - ".github/workflows/cml.yml"
  pull_request:
    branches: [main, dev]
    paths:
      - "ml/**"
      - "requirements.txt"

env:
  PYTHON_VERSION: "3.11"
  AWS_DEFAULT_REGION: eu-west-3

jobs:
  train-model:
    name: Training Model
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-ml-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-ml-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure DVC
        run: |
          dvc remote modify s3remote --local access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          dvc remote modify s3remote --local secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Pull data from DVC
        id: dvc_pull
        # FAIL if data cannot be pulled. Do not continue.
        run: dvc pull
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Train Model
        id: train
        # Logs to Databricks MLflow and creates local artifacts for CML
        run: |
          python -m ml.train \
            --mlflow-uri "${{ secrets.DATABRICKS_HOST }}" \
            --register
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          PYTHONPATH: .

      - name: Setup CML
        uses: iterative/setup-cml@v2

      - name: Generate Training Plots
        run: |
          python - <<'PYCODE'
          import pandas as pd
          import matplotlib.pyplot as plt

          try:
              df = pd.read_csv("training_history.csv")
              
              # Plot Loss
              plt.figure(figsize=(10, 6))
              plt.plot(df['stage'], df['train_loss'], label='Train Loss')
              plt.plot(df['stage'], df['test_loss'], label='Test Loss')
              plt.title('Loss Evolution')
              plt.xlabel('Stage')
              plt.ylabel('Loss')
              plt.legend()
              plt.grid(True)
              plt.savefig('loss_graph.png')
              plt.close()
              
              # Plot Accuracy
              plt.figure(figsize=(10, 6))
              plt.plot(df['stage'], df['train_accuracy'], label='Train Acc')
              plt.plot(df['stage'], df['test_accuracy'], label='Test Acc')
              plt.title('Accuracy Evolution')
              plt.xlabel('Stage')
              plt.ylabel('Accuracy')
              plt.legend()
              plt.grid(True)
              plt.savefig('accuracy_graph.png')
              plt.close()
              
              # Plot F1
              plt.figure(figsize=(10, 6))
              plt.plot(df['stage'], df['train_f1'], label='Train F1')
              plt.plot(df['stage'], df['test_f1'], label='Test F1')
              plt.title('F1 Score Evolution')
              plt.xlabel('Stage')
              plt.ylabel('F1 Score')
              plt.legend()
              plt.grid(True)
              plt.savefig('f1_graph.png')
              plt.close()
              
              print("âœ… Generated all training plots")
          except Exception as e:
              print(f"âŒ Failed to generate plots: {e}")
          PYCODE

      - name: Generate CML Report
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ github.head_ref || github.ref_name }}
          SHA: ${{ github.sha }}
        run: |
          python - <<'PYCODE'
          import json
          import os
          from pathlib import Path

          try:
              metrics = json.loads(Path("metrics.json").read_text())
          except FileNotFoundError:
              metrics = {}

          branch = os.environ.get("BRANCH", "n/a")
          sha = os.environ.get("SHA", "n/a")

          def fmt(name: str) -> str:
              val = metrics.get(name)
              return f"{val:.4f}" if isinstance(val, (int, float)) else "n/a"

          lines = [
              "## ðŸ“Š ML Training Report",
              "",
              f"**Branch:** {branch}",
              f"**Commit:** {sha}",
              "",
              "### ðŸ“ˆ Model Performance",
              "",
              "| Metric | Value |",
              "|:--- | ---:|",
              f"| Accuracy | {fmt('accuracy')} |",
              f"| Precision | {fmt('precision')} |",
              f"| Recall | {fmt('recall')} |",
              f"| F1-score | {fmt('f1_score')} |",
              f"| ROC AUC | {fmt('roc_auc')} |",
              "",
              "### ðŸ“Š Visualizations",
              "",
              "#### Loss Evolution",
              "![Loss](./loss_graph.png)",
              "",
              "#### Accuracy Evolution",
              "![Accuracy](./accuracy_graph.png)",
              "",
              "#### F1 Score Evolution",
              "![F1 Score](./f1_graph.png)",
              "",
              "#### Confusion Matrix",
              "![Confusion Matrix](./confusion_matrix.png)",
              "",
              "---",
              f"*Report generated automatically by CML*",
          ]

          Path("report.md").write_text("\n".join(lines))
          PYCODE

          # Publish the report
          cml comment create report.md

      - name: Upload metrics artifact
        uses: actions/upload-artifact@v4
        with:
          name: training-metrics
          path: |
            metrics.json
            training_history.csv
            confusion_matrix.png
            loss_graph.png
            accuracy_graph.png
            f1_graph.png