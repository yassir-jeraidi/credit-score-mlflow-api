name: CML - Continuous Machine Learning

on:
  push:
    branches: [main, dev]
    paths:
      - "ml/**"
      - "requirements.txt"
      - "params.yaml"
      - "dvc.yaml"
      - ".github/workflows/cml.yml"
  pull_request:
    branches: [main, dev]
    paths:
      - "ml/**"
      - "requirements.txt"
      - "params.yaml"
      - "dvc.yaml"

env:
  PYTHON_VERSION: "3.11"
  AWS_DEFAULT_REGION: eu-west-3

jobs:
  train-model:
    name: Training Model
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-ml-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-ml-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure DVC
        run: |
          dvc remote modify s3remote --local access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          dvc remote modify s3remote --local secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Pull data from DVC
        id: dvc_pull
        run: dvc pull
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Run DVC Pipeline
        id: dvc_repro
        run: dvc repro
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          AWS_REGION: eu-west-3
          AWS_DEFAULT_REGION: eu-west-3
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          PYTHONPATH: .

      - name: Setup CML
        uses: iterative/setup-cml@v2

      - name: Generate CML Report
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ github.head_ref || github.ref_name }}
          SHA: ${{ github.sha }}
        run: |
          # Generate DVC metrics diff
          echo "## ðŸ“Š ML Training Report" > report.md
          echo "" >> report.md
          echo "**Branch:** $BRANCH" >> report.md
          echo "**Commit:** $SHA" >> report.md
          echo "" >> report.md
          
          # Add metrics comparison
          echo "### ðŸ“ˆ Model Performance" >> report.md
          echo "" >> report.md
          dvc metrics show --md >> report.md || echo "No metrics to display" >> report.md
          echo "" >> report.md
          
          # Add metrics diff if on PR
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "### ðŸ“Š Changes from main" >> report.md
            echo "" >> report.md
            dvc metrics diff main --md >> report.md || echo "No diff available" >> report.md
            echo "" >> report.md
          fi
          
          # Add plots
          echo "### ðŸ“Š Visualizations" >> report.md
          echo "" >> report.md
          
          # Publish plots using CML
          if [ -f "training_history.csv" ]; then
            echo "#### Training Metrics" >> report.md
            dvc plots show training_history.csv -o plots/ || echo "Unable to generate plots" >> report.md
            
            # Find and embed generated plots
            for plot in plots/*.png; do
              if [ -f "$plot" ]; then
                echo "![$plot]($plot)" >> report.md
              fi
            done
          fi
          
          if [ -f "confusion_matrix.png" ]; then
            echo "#### Confusion Matrix" >> report.md
            cml publish confusion_matrix.png --md >> report.md
            echo "" >> report.md
          fi
          
          echo "---" >> report.md
          echo "*Report generated automatically by CML + DVC*" >> report.md

          # Publish the report
          cml comment create report.md

      - name: Push DVC outputs to remote
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          dvc push
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: training-metrics
          path: |
            metrics.json
            training_history.csv
            confusion_matrix.png
            dvc.lock